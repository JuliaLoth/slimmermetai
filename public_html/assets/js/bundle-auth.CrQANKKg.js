const u="/api";let f=null,i=null;function a(t){console.log(`[Auth Debug] ${t}`)}function S(){a("InitAuth aangeroepen");const t=localStorage.getItem("token"),e=localStorage.getItem("user");return t&&e?(a("Token en user gevonden in localStorage"),i=t,f=JSON.parse(e),!0):(a("Geen token of user gevonden in localStorage"),!1)}async function w(t){try{const e=await fetch(`${u}/auth/register.php`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":t.csrf_token||""},credentials:"include",body:JSON.stringify(t)});return await d(e)}catch(e){return console.error("Registratie fout:",e),{success:!1,message:"Er is een fout opgetreden bij de registratie"}}}async function y(t,e){let s,o,n=!1;typeof t=="object"&&t!==null?(s=t.email||"",o=t.password||"",n=t.rememberMe||t.remember||!1):(s=t,o=e),a(`Login poging voor: ${s}`);try{a("Versturen van login verzoek naar API...");const c=await fetch(`${u}/auth/login.php`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:s,password:o,remember:n})});a(`API response status: ${c.status}`);const r=await d(c);return a(`API response data: ${JSON.stringify(r)}`),r.success&&r.access_token?(a("Login succesvol, token opslaan"),i=r.access_token,f=r.user,localStorage.setItem("token",r.access_token),localStorage.setItem("user",JSON.stringify(r.user))):a(`Login mislukt: ${r.message||"Onbekende fout"}`),r}catch(c){return a(`Login fout: ${c.message}`),console.error("Login fout:",c),{success:!1,message:"Er is een fout opgetreden bij het inloggen"}}}async function v(){try{return i&&await fetch(`${u}/auth/logout.php`,{method:"POST",headers:{Authorization:`Bearer ${i}`},credentials:"include"}),h(),{success:!0}}catch(t){return console.error("Logout fout:",t),h(),{success:!1,message:"Er is een fout opgetreden bij het uitloggen"}}}async function T(){try{const t=await fetch(`${u}/auth/refresh-token.php`,{method:"POST",credentials:"include"}),e=await d(t);return e.success&&e.token&&(i=e.token,f=e.user,localStorage.setItem("token",e.token),localStorage.setItem("user",JSON.stringify(e.user))),e}catch(t){return console.error("Token vernieuwing fout:",t),{success:!1,message:"Token vernieuwing mislukt"}}}async function E(){try{if(!i)return{success:!1,message:"Niet ingelogd"};const t=await fetch(`${u}/auth/me.php`,{method:"GET",headers:{Authorization:`Bearer ${i}`}}),e=await d(t);return e.success&&e.user&&(f=e.user,localStorage.setItem("user",JSON.stringify(e.user))),e}catch(t){return console.error("Fout bij ophalen gebruiker:",t),{success:!1,message:"Kan gebruiker niet ophalen"}}}async function I(t){try{if(!i)return{success:!1,message:"Niet ingelogd"};const e=await fetch(`${u}/users/profile`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(t)}),s=await d(e);return s.success&&s.user&&(f=s.user,localStorage.setItem("user",JSON.stringify(s.user))),s}catch(e){return console.error("Fout bij bijwerken profiel:",e),{success:!1,message:"Kan profiel niet bijwerken"}}}async function L(t,e){try{if(!i)return{success:!1,message:"Niet ingelogd"};const s=await fetch(`${u}/users/password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({currentPassword:t,newPassword:e})});return await d(s)}catch(s){return console.error("Fout bij wijzigen wachtwoord:",s),{success:!1,message:"Kan wachtwoord niet wijzigen"}}}async function b(t){try{const e=await fetch(`${u}/auth/forgot-password.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});return await d(e)}catch(e){return console.error("Fout bij wachtwoord vergeten:",e),{success:!1,message:"Kan wachtwoord reset niet aanvragen"}}}async function $(t,e){try{const s=await fetch(`${u}/auth/reset-password.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,password:e})});return await d(s)}catch(s){return console.error("Fout bij resetten wachtwoord:",s),{success:!1,message:"Kan wachtwoord niet resetten"}}}function j(){window.location.href=`${u}/auth/google.php`}async function A(t){try{const e=await fetch(`${u}/auth/verify-email.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});return await d(e)}catch(e){return console.error("Fout bij verifiëren email:",e),{success:!1,message:"Kan email niet verifiëren"}}}async function P(){try{if(!i)return{success:!1,message:"Niet ingelogd"};const t=await fetch(`${u}/users/account`,{method:"DELETE",headers:{Authorization:`Bearer ${i}`}}),e=await d(t);return e.success&&h(),e}catch(t){return console.error("Fout bij verwijderen account:",t),{success:!1,message:"Kan account niet verwijderen"}}}async function d(t){a(`Verwerken van response: ${t.status}`);try{let e;try{e=await t.json()}catch{const o=await t.text();a(`Response is geen JSON, raw text: ${o.substring(0,100)}`),e={message:o}}return a(`Response data: ${JSON.stringify(e)}`),t.ok?{success:!0,...e}:(a(`API fout: ${e.message||t.statusText}`),{success:!1,message:e.message||"Er is een fout opgetreden"})}catch(e){return a(`Response verwerking fout: ${e.message}`),{success:!1,message:"Kan response niet verwerken"}}}function h(){i=null,f=null,localStorage.removeItem("token"),localStorage.removeItem("user")}function O(){return!!i}function N(){return f&&f.role==="admin"}window.auth={initAuth:S,register:w,login:y,logout:v,refreshToken:T,getCurrentUser:E,updateProfile:I,changePassword:L,forgotPassword:b,resetPassword:$,googleLogin:j,verifyEmail:A,deleteAccount:P,isLoggedIn:O,isAdmin:N};function k(t,e){const s=document.getElementById(t);if(!s)return;const o=e.querySelector("svg");s.type==="password"?(s.type="text",o&&(o.innerHTML='<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>')):(s.type="password",o&&(o.innerHTML='<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>'))}function g(t,e){const s=document.getElementById("login-message");s&&(s.textContent=e,s.className="auth-message",t==="success"?s.classList.add("auth-message--success"):t==="error"?s.classList.add("auth-message--error"):t==="info"&&s.classList.add("auth-message--info"),s.style.display="block")}function p(){a("Initialiseren van login pagina specifieke logica..."),window.togglePasswordVisibility=k,auth.isLoggedIn(),F(),J(),D(),C()}function F(){const t=document.querySelectorAll(".auth-tab"),e=document.querySelectorAll(".auth-form");t.forEach(n=>{n.addEventListener("click",function(c){c.preventDefault();const r=this.getAttribute("data-target");t.forEach(l=>l.classList.remove("active")),this.classList.add("active"),e.forEach(l=>{l.id===r?l.style.display="block":l.style.display="none"});const m=new URL(window.location);m.searchParams.set("tab",r),window.history.replaceState(null,"",m)})});const o=new URLSearchParams(window.location.search).get("tab");if(o){const n=document.querySelector(`[data-target="${o}"]`);n&&n.click()}}function J(){const t=document.getElementById("login-form");t&&t.addEventListener("submit",async function(o){o.preventDefault();const n=new FormData(this),c=n.get("email"),r=n.get("password"),m=n.get("remember")==="on";g("info","Inloggen...");const l=await y({email:c,password:r,rememberMe:m});l.success?(g("success","Succesvol ingelogd! Je wordt doorgestuurd..."),setTimeout(()=>{l.redirect?window.location.href=l.redirect:window.location.href="/dashboard"},1e3)):g("error",l.message||"Inloggen mislukt")});const e=document.getElementById("register-form");e&&e.addEventListener("submit",async function(o){o.preventDefault();const n=new FormData(this),c={name:n.get("name"),email:n.get("email"),password:n.get("password"),confirm_password:n.get("confirm_password"),csrf_token:n.get("_token")};g("info","Account aanmaken...");const r=await w(c);r.success?(g("success","Account succesvol aangemaakt! Je wordt doorgestuurd..."),setTimeout(()=>{r.redirect?window.location.href=r.redirect:window.location.href="/dashboard"},1e3)):g("error",r.message||"Registratie mislukt")});const s=document.getElementById("forgot-password-form");s&&s.addEventListener("submit",async function(o){o.preventDefault();const c=new FormData(this).get("email");g("info","Wachtwoord reset aanvragen...");const r=await b(c);r.success?g("success","Reset email verzonden! Controleer je inbox."):g("error",r.message||"Reset aanvraag mislukt")})}function D(){document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",function(){const s=this.getAttribute("data-target");k(s,this)})})}function C(){const t=document.querySelector('meta[name="csrf-token"]');if(!t)return;const e=t.getAttribute("content");document.querySelectorAll(".auth-form form").forEach(o=>{let n=o.querySelector('input[name="_token"]');n||(n=document.createElement("input"),n.type="hidden",n.name="_token",o.appendChild(n)),n.value=e})}document.addEventListener?document.addEventListener("DOMContentLoaded",p):document.attachEvent&&document.attachEvent("onreadystatechange",function(){document.readyState==="complete"&&p()});
