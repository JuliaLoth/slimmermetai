const i="/api";let g=null,r=null;function n(t){console.log(`[Auth Debug] ${t}`)}function y(){n("InitAuth aangeroepen");const t=localStorage.getItem("token"),e=localStorage.getItem("user");return t&&e?(n("Token en user gevonden in localStorage"),r=t,g=JSON.parse(e),!0):(n("Geen token of user gevonden in localStorage"),!1)}async function b(t){try{const e=await fetch(`${i}/auth/register.php`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":t.csrf_token||""},credentials:"include",body:JSON.stringify(t)});return await u(e)}catch(e){return console.error("Registratie fout:",e),{success:!1,message:"Er is een fout opgetreden bij de registratie"}}}async function S(t,e){let s,a,f=!1;typeof t=="object"&&t!==null?(s=t.email||"",a=t.password||"",f=t.rememberMe||t.remember||!1):(s=t,a=e),n(`Login poging voor: ${s}`);try{n("Versturen van login verzoek naar API...");const l=await fetch(`${i}/auth/login.php`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:s,password:a,remember:f})});n(`API response status: ${l.status}`);const o=await u(l);return n(`API response data: ${JSON.stringify(o)}`),o.success&&o.access_token?(n("Login succesvol, token opslaan"),r=o.access_token,g=o.user,localStorage.setItem("token",o.access_token),localStorage.setItem("user",JSON.stringify(o.user))):n(`Login mislukt: ${o.message||"Onbekende fout"}`),o}catch(l){return n(`Login fout: ${l.message}`),console.error("Login fout:",l),{success:!1,message:"Er is een fout opgetreden bij het inloggen"}}}async function k(){try{return r&&await fetch(`${i}/auth/logout.php`,{method:"POST",headers:{Authorization:`Bearer ${r}`},credentials:"include"}),w(),{success:!0}}catch(t){return console.error("Logout fout:",t),w(),{success:!1,message:"Er is een fout opgetreden bij het uitloggen"}}}async function v(){try{const t=await fetch(`${i}/auth/refresh-token.php`,{method:"POST",credentials:"include"}),e=await u(t);return e.success&&e.token&&(r=e.token,g=e.user,localStorage.setItem("token",e.token),localStorage.setItem("user",JSON.stringify(e.user))),e}catch(t){return console.error("Token vernieuwing fout:",t),{success:!1,message:"Token vernieuwing mislukt"}}}async function L(){try{if(!r)return{success:!1,message:"Niet ingelogd"};const t=await fetch(`${i}/auth/me.php`,{method:"GET",headers:{Authorization:`Bearer ${r}`}}),e=await u(t);return e.success&&e.user&&(g=e.user,localStorage.setItem("user",JSON.stringify(e.user))),e}catch(t){return console.error("Fout bij ophalen gebruiker:",t),{success:!1,message:"Kan gebruiker niet ophalen"}}}async function I(t){try{if(!r)return{success:!1,message:"Niet ingelogd"};const e=await fetch(`${i}/users/profile`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(t)}),s=await u(e);return s.success&&s.user&&(g=s.user,localStorage.setItem("user",JSON.stringify(s.user))),s}catch(e){return console.error("Fout bij bijwerken profiel:",e),{success:!1,message:"Kan profiel niet bijwerken"}}}async function T(t,e){try{if(!r)return{success:!1,message:"Niet ingelogd"};const s=await fetch(`${i}/users/password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({currentPassword:t,newPassword:e})});return await u(s)}catch(s){return console.error("Fout bij wijzigen wachtwoord:",s),{success:!1,message:"Kan wachtwoord niet wijzigen"}}}async function $(t){try{const e=await fetch(`${i}/auth/forgot-password.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});return await u(e)}catch(e){return console.error("Fout bij wachtwoord vergeten:",e),{success:!1,message:"Kan wachtwoord reset niet aanvragen"}}}async function E(t,e){try{const s=await fetch(`${i}/auth/reset-password.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t,password:e})});return await u(s)}catch(s){return console.error("Fout bij resetten wachtwoord:",s),{success:!1,message:"Kan wachtwoord niet resetten"}}}function j(){window.location.href=`${i}/auth/google.php`}async function O(t){try{const e=await fetch(`${i}/auth/verify-email.php`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});return await u(e)}catch(e){return console.error("Fout bij verifiëren email:",e),{success:!1,message:"Kan email niet verifiëren"}}}async function A(){try{if(!r)return{success:!1,message:"Niet ingelogd"};const t=await fetch(`${i}/users/account`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}}),e=await u(t);return e.success&&w(),e}catch(t){return console.error("Fout bij verwijderen account:",t),{success:!1,message:"Kan account niet verwijderen"}}}async function u(t){n(`Verwerken van response: ${t.status}`);try{let e;try{e=await t.json()}catch{const a=await t.text();n(`Response is geen JSON, raw text: ${a.substring(0,100)}`),e={message:a}}return n(`Response data: ${JSON.stringify(e)}`),t.ok?{success:!0,...e}:(n(`API fout: ${e.message||t.statusText}`),{success:!1,message:e.message||"Er is een fout opgetreden"})}catch(e){return n(`Response verwerking fout: ${e.message}`),{success:!1,message:"Kan response niet verwerken"}}}function w(){r=null,g=null,localStorage.removeItem("token"),localStorage.removeItem("user")}function P(){return!!r}function N(){return g&&g.role==="admin"}window.auth={initAuth:y,register:b,login:S,logout:k,refreshToken:v,getCurrentUser:L,updateProfile:I,changePassword:T,forgotPassword:$,resetPassword:E,googleLogin:j,verifyEmail:O,deleteAccount:A,isLoggedIn:P,isAdmin:N};function B(t,e){const s=document.getElementById(t);if(!s)return;const a=e.querySelector("svg");s.type==="password"?(s.type="text",a&&(a.innerHTML='<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>')):(s.type="password",a&&(a.innerHTML='<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>'))}function d(t,e){const s=document.getElementById("login-message");s&&(s.textContent=e,s.className="auth-message",t==="success"?s.classList.add("auth-message--success"):t==="error"?s.classList.add("auth-message--error"):t==="info"&&s.classList.add("auth-message--info"),s.style.display="block")}function C(){n("Initialiseren van login pagina specifieke logica..."),window.togglePasswordVisibility=B,auth.isLoggedIn();const t=document.getElementById("emailLoginForm"),e=document.getElementById("loginButton"),s=document.getElementById("google-signin-button"),a=document.getElementById("microsoft-signin-button");t&&e&&t.addEventListener("submit",async o=>{o.preventDefault(),d("info","Bezig met inloggen..."),e.textContent="Bezig...",e.disabled=!0;const m=new FormData(t),h=m.get("email"),p=m.get("password");m.get("csrf_token");try{const c=await auth.login(h,p);c.success?(d("success","Succesvol ingelogd! Je wordt doorverwezen..."),window.location.href=c.redirectUrl||"dashboard.php"):(d("error",c.message||"Ongeldige e-mail of wachtwoord."),e.textContent="Inloggen",e.disabled=!1)}catch(c){n(`Login error: ${c.message}`),d("error","Er is een technische fout opgetreden. Probeer het later opnieuw."),e.textContent="Inloggen",e.disabled=!1}}),s&&s.addEventListener("click",()=>{n("Google Sign-In button clicked!"),d("info","Google login wordt geïnitialiseerd..."),auth.googleLogin()}),a&&a.addEventListener("click",()=>{n("Microsoft Sign-In button clicked!"),d("info","Microsoft login wordt geïnitialiseerd..."),d("error","Microsoft login is nog niet geïmplementeerd.")});const f=document.querySelector("slimmer-auth-form-card");f&&f.addEventListener("tab-change",o=>{n("Tab changed to: "+o.detail.tabId)}),n("Login pagina initialisatie voltooid.");const l=document.querySelector(".auth-tabs");if(l){const o=l.querySelectorAll(".tab-btn"),m=document.querySelectorAll(".tab-content[data-tab-content]");o.forEach(h=>{h.addEventListener("click",()=>{const p=h.getAttribute("data-tab");o.forEach(c=>c.classList.remove("active")),h.classList.add("active"),m.forEach(c=>{c.getAttribute("data-tab-content")===p?c.classList.add("active"):c.classList.remove("active")})})})}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("emailLoginForm")&&C()});
